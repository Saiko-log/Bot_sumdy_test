<script>
    // Инициализируем Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();

    // АДРЕС ВАШЕГО БЭКЕНДА. 
    // Если запускаете локально для теста, можно использовать http://localhost:8080
    // Для реальной работы сюда нужно вставить публичный адрес вашего сервера.
    const BACKEND_URL = "https://wisplike-stetson-pseudocerysipelas.ngrok-free.dev";
    // Функция для загрузки и отображения расписания
    async function loadAndRenderSchedule() {
        const container = document.getElementById('schedule-container');
        container.innerHTML = '<p>Загрузка расписания...</p>';

        try {
            // Отправляем запрос на наш бэкенд
            const response = await fetch(`${BACKEND_URL}/getSchedule`);
            const classes = await response.json();

            container.innerHTML = ''; // Очищаем контейнер

            if (classes.length === 0) {
                container.innerHTML = '<p>Расписание пусто. Загрузите файл .ics через бота.</p>';
                return;
            }

            classes.forEach(cls => {
                const card = document.createElement('div');
                card.className = 'class-card';

                const startTime = new Date(cls.dtstart).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const endTime = new Date(cls.dtend).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const classDate = new Date(cls.dtstart).toLocaleDateString();

                // Извлекаем имя преподавателя из описания
                const teacher = cls.description ? cls.description.split('\\n')[0] : 'Не указан';

                card.innerHTML = `
                    <div class="class-title">${cls.summary || 'Без названия'}</div>
                    <div class="class-time">${classDate} (${startTime} - ${endTime})</div>
                    <div class="class-details">
                        <p><strong>Преподаватель:</strong> ${teacher}</p>
                    </div>
                    <div class="class-notes">
                        <label for="link-${cls.uid}">Ссылка на лекцию:</label>
                        <input type="url" id="link-${cls.uid}" value="${cls.link || ''}" placeholder="https://zoom.us/...">
                        <label for="notes-${cls.uid}">Мои заметки:</label>
                        <textarea id="notes-${cls.uid}" rows="3" placeholder="Домашнее задание, важные моменты...">${cls.notes || ''}</textarea>
                        <button onclick="saveChanges('${cls.uid}')">Сохранить</button>
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            container.innerHTML = `<p>Ошибка загрузки расписания: ${error.message}. Убедитесь, что бэкенд запущен и доступен.</p>`;
            console.error("Fetch error:", error);
        }
    }

    // Функция для сохранения изменений
    async function saveChanges(uid) {
        const link = document.getElementById(`link-${uid}`).value;
        const notes = document.getElementById(`notes-${uid}`).value;

        try {
            const response = await fetch(`${BACKEND_URL}/saveNotes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ uid, link, notes }),
            });

            if (response.ok) {
                // Показываем уведомление об успехе
                tg.showPopup({
                    title: 'Сохранено!',
                    message: 'Ваши заметки и ссылка были успешно обновлены.',
                    buttons: [{type: 'ok'}]
                });
            } else {
                throw new Error('Ошибка сохранения данных');
            }
        } catch (error) {
            tg.showPopup({
                title: 'Ошибка',
                message: error.message,
                buttons: [{type: 'ok'}]
            });
            console.error("Save error:", error);
        }
    }

    // Запускаем загрузку расписания при открытии страницы
    loadAndRenderSchedule();
</script>