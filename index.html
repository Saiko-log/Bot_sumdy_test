<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мое Расписание</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff); --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999); --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f1f1f1);
            --tg-button: var(--tg-theme-button-color, #007bff); --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --border-color: #e5e5e5; --event-bg: #cce5ff; --event-border: #007bff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: var(--tg-bg); color: var(--tg-text); }
        #settings-btn { position: fixed; top: 10px; right: 15px; font-size: 24px; cursor: pointer; z-index: 100; }
        .view-switcher { display: flex; justify-content: center; margin-bottom: 15px; }
        .view-switcher button { background-color: var(--tg-secondary-bg); color: var(--tg-text); border: 1px solid var(--border-color); padding: 8px 16px; cursor: pointer; font-size: 14px; }
        .view-switcher button:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .view-switcher button:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-left: none; }
        .view-switcher button.active { background-color: var(--tg-button); color: var(--tg-button-text); border-color: var(--tg-button); }
        .schedule-container { position: relative; padding-left: 55px; min-height: 1200px; }
        .time-marker { position: absolute; left: 0; width: 45px; text-align: right; padding-right: 10px; font-size: 11px; color: var(--tg-hint); transform: translateY(-50%); }
        .time-line { position: absolute; left: 55px; right: 0; height: 1px; background-color: var(--border-color); }
        .class-card { background-color: var(--tg-secondary-bg); border-left: 3px solid var(--event-border); border-radius: 8px; padding: 5px 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; cursor: pointer; box-sizing: border-box; }
        .class-title { font-weight: bold; font-size: 0.9em; }
        .class-time, .class-teacher, .global-link { color: var(--tg-hint); font-size: 0.8em; margin-top: 3px; }
        .global-link a { color: var(--tg-button); text-decoration: none; font-weight: bold; }
        .day-separator { font-weight: bold; font-size: 1.2em; padding: 20px 0 10px; position: relative; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--tg-secondary-bg); padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-title { margin: 0; font-size: 1.2em; }
        .close-button { color: var(--tg-hint); font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        .modal-body input, .modal-body textarea { box-sizing: border-box; width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--tg-bg); color: var(--tg-text); }
        .modal-body button { background-color: var(--tg-button); color: var(--tg-button-text); border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-top: 20px; width: 100%; }
        .admin-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .admin-list li { margin-bottom: 15px; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .admin-list button { width: auto; padding: 5px 10px; font-size: 0.8em; float: right; }
    </style>
</head>
<body>
    <div id="settings-btn">⚙️</div>
    <div class="view-switcher">
        <button id="today-btn" class="active">Сегодня</button>
        <button id="week-btn">Неделя</button>
    </div>
    <div id="schedule-container" class="schedule-container"></div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="modal-title" class="modal-title"></h2> <span class="close-button" id="modal-close-button">&times;</span> </div>
            <div class="modal-body">
                <input type="hidden" id="modal-uid">
                <label for="modal-link">Личная ссылка:</label> <input type="url" id="modal-link">
                <label for="modal-notes">Личные заметки:</label> <textarea id="modal-notes" rows="4"></textarea>
                <button id="modal-save">Сохранить заметку</button>
            </div>
        </div>
    </div>
    
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Настройки ссылок</h2>
                <span class="close-button" id="admin-close-button">&times;</span>
            </div>
            <div class="modal-body">
                <ul id="subject-list" class="admin-list"></ul>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            const tg = window.Telegram.WebApp;
            tg.ready();

            const BACKEND_URL = "https://sumdu-schedule-bot.onrender.com";
            const scheduleContainer = document.getElementById('schedule-container');
            const modal = document.getElementById('modal');
            const adminModal = document.getElementById('admin-modal');
            const todayBtn = document.getElementById('today-btn');
            const weekBtn = document.getElementById('week-btn');
            const settingsBtn = document.getElementById('settings-btn');
            
            let currentView = 'today';
            let all_classes = [];

            // --- ОБЩАЯ ЛОГИКА ---
            async function initialLoad() {
                try {
                    const response = await fetch(`${BACKEND_URL}/getSchedule`);
                    if (!response.ok) throw new Error(`HTTP error!`);
                    all_classes = await response.json();
                    all_classes.sort((a, b) => new Date(a.dtstart) - new Date(b.dtstart));
                    renderSchedule();
                } catch (error) {
                    scheduleContainer.innerHTML = `<p style="padding-left: 60px;">Ошибка загрузки расписания.</p>`;
                    console.error("Fetch error:", error);
                }
            }

            // --- ЛОГИКА ПЕРЕКЛЮЧАТЕЛЯ ВИДА ---
            todayBtn.onclick = () => switchView('today');
            weekBtn.onclick = () => switchView('week');
            function switchView(view) {
                currentView = view;
                todayBtn.classList.toggle('active', view === 'today');
                weekBtn.classList.toggle('active', view === 'week');
                renderSchedule();
            }

            // --- ОСНОВНАЯ ФУНКЦИЯ ОТРИСОВКИ ---
            function renderSchedule() {
                scheduleContainer.innerHTML = '';
                if (all_classes.length === 0) {
                    scheduleContainer.innerHTML = '<p style="padding-left: 60px;">Расписание пусто. Загрузите файл .ics через бота.</p>';
                    return;
                }
                if (currentView === 'today') {
                    const today = new Date();
                    const classesToRender = all_classes.filter(cls => {
                        const classDate = new Date(cls.dtstart);
                        return classDate.getDate() === today.getDate() && classDate.getMonth() === today.getMonth() && classDate.getFullYear() === today.getFullYear();
                    });
                    renderTodayView(classesToRender);
                } else {
                    renderWeekView(all_classes);
                }
            }

            // --- ОТРИСОВКА ВИДА "НЕДЕЛЯ" ---
            function renderWeekView(classes) {
                scheduleContainer.style.height = 'auto';
                scheduleContainer.style.paddingLeft = '10px';
                let currentDay = -1;
                const daysOfWeek = ["Воскресенье", "Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"];

                classes.forEach(cls => {
                    const startDate = new Date(cls.dtstart);
                    if (startDate.getDay() !== currentDay) {
                        const daySeparator = document.createElement('div');
                        daySeparator.className = 'day-separator';
                        daySeparator.innerText = `${daysOfWeek[startDate.getDay()]}, ${startDate.toLocaleDateString()}`;
                        scheduleContainer.appendChild(daySeparator);
                        currentDay = startDate.getDay();
                    }
                    scheduleContainer.appendChild(renderCard(cls, false));
                });
            }

            // --- ОТРИСОВКА ВИДА "СЕГОДНЯ" ---
            function renderTodayView(classes) {
                scheduleContainer.style.paddingLeft = '55px';
                const PIXELS_PER_HOUR = 80, START_HOUR = 7, END_HOUR = 21;

                for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                    const topPosition = (hour - START_HOUR) * PIXELS_PER_HOUR;
                    const timeMarker = document.createElement('div');
                    timeMarker.className = 'time-marker';
                    timeMarker.innerText = `${hour}:00`;
                    timeMarker.style.top = `${topPosition}px`;
                    scheduleContainer.appendChild(timeMarker);
                    const timeLine = document.createElement('div');
                    timeLine.className = 'time-line';
                    timeLine.style.top = `${topPosition}px`;
                    scheduleContainer.appendChild(timeLine);
                }
                scheduleContainer.style.height = `${(END_HOUR - START_HOUR + 1) * PIXELS_PER_HOUR}px`;

                if (classes.length === 0) {
                    const msg = document.createElement('p');
                    msg.innerText = 'На сегодня пар нет.';
                    msg.style.paddingLeft = '60px';
                    scheduleContainer.appendChild(msg);
                } else {
                    classes.forEach(cls => scheduleContainer.appendChild(renderCard(cls, true)));
                }
            }

            // --- ОБЩАЯ ФУНКЦИЯ ОТРИСОВКИ КАРТОЧКИ ---
            function renderCard(cls, isTimelineView) {
                const startDate = new Date(cls.dtstart);
                const endDate = new Date(cls.dtend);
                const teacher = cls.description ? cls.description.split('\\n')[0] : 'Не указан';
                const card = document.createElement('div');
                card.className = 'class-card';
                
                if (isTimelineView) {
                    const PIXELS_PER_HOUR = 80, START_HOUR = 7;
                    const pixelsPerMinute = PIXELS_PER_HOUR / 60;
                    const startOffsetMinutes = (startDate.getHours() * 60 + startDate.getMinutes()) - (START_HOUR * 60);
                    const durationMinutes = (endDate - startDate) / 1000 / 60;
                    card.style.position = 'absolute';
                    card.style.top = `${startOffsetMinutes * pixelsPerMinute}px`;
                    card.style.height = `${durationMinutes * pixelsPerMinute - 2}px`;
                    card.style.left = '60px';
                    card.style.right = '5px';
                } else {
                    card.style.position = 'relative';
                    card.style.marginBottom = '10px';
                }

                card.innerHTML = `
                    <div class="class-title">${cls.summary || 'Без названия'}</div>
                    ${cls.global_link ? `<div class="global-link"><a href="${cls.global_link}" target="_blank" onclick="event.stopPropagation()">🔗 Ссылка на лекцию</a></div>` : ''}
                    <div class="class-time">${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    <div class="class-teacher">${teacher}</div>
                `;
                card.onclick = () => openModal(cls);
                return card;
            }

            // --- ЛОГИКА МОДАЛЬНЫХ ОКОН ---
            function openModal(cls) {
                modal.innerHTML = `...`; // Содержимое генерируется
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header"> <h2 id="modal-title" class="modal-title">${cls.summary || 'Детали'}</h2> <span class="close-button" id="modal-close-button">&times;</span> </div>
                        <div class="modal-body">
                            <input type="hidden" id="modal-uid" value="${cls.uid}">
                            <label for="modal-link">Личная ссылка:</label> <input type="url" id="modal-link" value="${cls.link || ''}">
                            <label for="modal-notes">Личные заметки:</label> <textarea id="modal-notes" rows="4">${cls.notes || ''}</textarea>
                            <button id="modal-save">Сохранить заметку</button>
                        </div>
                    </div>`;
                modal.style.display = 'flex';
                modal.querySelector('#modal-close-button').onclick = closeModal;
                modal.querySelector('#modal-save').onclick = () => saveChanges(cls.uid);
            }
            function closeModal() { modal.style.display = 'none'; }
            
            async function saveChanges(uid) {
                const link = document.getElementById('modal-link').value;
                const notes = document.getElementById('modal-notes').value;
                try {
                    const response = await fetch(`${BACKEND_URL}/saveNotes`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uid, link, notes }),
                    });
                    if (response.ok) {
                        const index = all_classes.findIndex(c => c.uid === uid);
                        if (index !== -1) { all_classes[index].link = link; all_classes[index].notes = notes; }
                        closeModal();
                        tg.showPopup({ title: 'Сохранено!', message: 'Ваши личные заметки обновлены.', buttons: [{type: 'ok'}] });
                    } else { throw new Error('Ошибка сохранения данных'); }
                } catch (error) {
                    tg.showPopup({ title: 'Ошибка', message: error.message, buttons: [{type: 'ok'}] });
                }
            }
            
            // --- ЛОГИКА АДМИН-ПАНЕЛИ ---
            settingsBtn.onclick = () => {
                const password = prompt("Введите пароль администратора:");
                if (password === "1234") { openAdminModal(); } 
                else if (password) { alert("Неверный пароль."); }
            };
            
            function openAdminModal() {
                const subjectList = document.createElement('ul');
                subjectList.className = 'admin-list';
                const uniqueSummaries = [...new Map(all_classes.map(item => [item.summary, item])).values()];
                uniqueSummaries.forEach(cls => {
                    if (!cls.summary) return;
                    const li = document.createElement('li');
                    const inputId = `link-${cls.summary.replace(/[^a-zA-Z0-9]/g, '')}`;
                    li.innerHTML = `
                        <label for="${inputId}">${cls.summary}</label>
                        <input type="url" id="${inputId}" value="${cls.global_link || ''}" placeholder="Постоянная ссылка на пару">
                        <button data-summary="${cls.summary}" data-input-id="${inputId}">Сохранить</button>
                    `;
                    subjectList.appendChild(li);
                });
                adminModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Настройки ссылок</h2>
                            <span class="close-button" id="admin-close-button">&times;</span>
                        </div>
                        <div class="modal-body"></div>
                    </div>`;
                adminModal.querySelector('.modal-body').appendChild(subjectList);
                adminModal.style.display = 'flex';
                adminModal.querySelector('#admin-close-button').onclick = () => adminModal.style.display = 'none';
            }

            adminModal.addEventListener('click', async (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.summary) {
                    const summary = e.target.dataset.summary;
                    const link = document.getElementById(e.target.dataset.inputId).value;
                    e.target.innerText = 'Сохр...';
                    await saveGlobalLink(summary, link);
                    e.target.innerText = 'Сохранено!';
                    setTimeout(() => { e.target.innerText = 'Сохранить'; }, 2000);
                }
            });

            async function saveGlobalLink(summary, link) {
                try {
                    const response = await fetch(`${BACKEND_URL}/saveGlobalLink`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ summary, link }),
                    });
                    if (response.ok) {
                        all_classes.forEach(c => { if (c.summary === summary) { c.global_link = link; } });
                        renderSchedule();
                    } else { throw new Error('Ошибка сохранения'); }
                } catch (error) { alert(error.message); }
            }

            // --- ЗАПУСК ---
            initialLoad();
        };
    </script>
</body>
</html>
